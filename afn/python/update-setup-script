#!/usr/bin/env python

import time
import sys
sys.path.append(__file__ + "/src")
from afn.fileutils import File

excluded_packages = ["simplejson", "nextgen", "music", "objects", "autolaunch", "interconnect"]
excluded_modules = ["landfill"]

with open("setup.py.template") as input:
    lines = list(input)
with open("setup.py", "w") as out:
    out.write("#!/usr/bin/env python\n\n")
    out.write("# DO NOT EDIT THIS FILE. Edit setup.py.template instead, then\n")
    out.write("# run update-setup-script to update this file.\n\n")
    for line in lines:
        if "# !!!VERSION!!!" in line:
            line = 'version = "0.1.%s" # !!!VERSION!!!\n' % time.strftime("%Y.%m.%d.%H.%M")
        elif "# !!!PACKAGES!!!" in line:
            line = ""
            for f in File("src").recurse(lambda t: t.name == "__init__.py"):
                package_name = f.path[len("src/"):-len("/__init__.py")].replace("/", ".")
                if package_name.partition(".")[0] in excluded_packages:
                    continue
                line += '        %r,\n' % package_name
        elif "# !!!MODULES!!!" in line:
            line = ""
            for f in File("src").list():
                if not f.name.endswith(".py"):
                    continue
                module_name = f.path[len("src/"):-len(".py")]
                if module_name in excluded_modules:
                    continue
                line += '        %r,\n' % module_name
        out.write(line)

